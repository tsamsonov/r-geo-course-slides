<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Продвинутая графика</title>
    <meta charset="utf-8" />
    <meta name="author" content="Тимофей Самсонов" />
    <meta name="date" content="2021-10-12" />
    <script src="libs/header-attrs-2.11/header-attrs.js"></script>
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link rel="stylesheet" href="custom.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Продвинутая графика
## Визуализация и анализ географических данных на языке R
### Тимофей Самсонов
### МГУ имени Ломоносова, Географический факультет
### 2021-10-12

---




## Источники данных

- __Евростат__ (https://ec.europa.eu/eurostat/web/main/home), 
- __NASA POWER__ (https://power.larc.nasa.gov/)
- __USDA NRCS Soil Data Access__ (https://sdmdataaccess.nrcs.usda.gov/)


```r
library(dplyr)
## 
## Присоединяю пакет: 'dplyr'
## Следующие объекты скрыты от 'package:stats':
## 
##     filter, lag
## Следующие объекты скрыты от 'package:base':
## 
##     intersect, setdiff, setequal, union
library(tidyr)
library(ggplot2)
library(eurostat)
library(nasapower)
library(soilDB)
```

&gt; Пакет soilDB лучше устанавливать из консоли командой `install.packages('soilDB', dependencies = TRUE)`. Указание параметра `dependencies = TRUE` обеспечит установку других пакетов, от которых он зависит.

---

## Коды Евростата {#advgraphics_eurostat}

Например, [таблица данных по продуктам питания, напиткам и табаку](https://ec.europa.eu/eurostat/databrowser/view/tet00034/default/table?lang=en) имеет код __tet00034__:

&lt;img src="img/eurostat.png" width="854" /&gt;

---

## Загрузка данных Евростата {#advgraphics_eurostat}


```r
tables = c('tet00034', 'tet00033', 'tet00032', 
           'tet00031','tet00030', 'tet00029')

trades = lapply(tables, function(X) { # прочтем несколько таблиц в список
* get_eurostat(X) |&gt;  label_eurostat()
}) |&gt; 
  bind_rows() |&gt;  # объединим прочитанные таблицы в одну
  select(-geo) |&gt;  # убираем столбец с территорией торговли
  filter(stringr::str_detect(indic_et, 'Exports in|Imports in')) |&gt; 
  pivot_wider(names_from = indic_et, values_from = values)  |&gt;
  rename(export = `Exports in million of ECU/EURO`,
         import = `Imports in million of ECU/EURO`) |&gt; 
  mutate(partner = as.factor(partner))
## Table tet00034 cached at /var/folders/5s/rkxr4m8j24569d_p6nj9ld200000gn/T//RtmpTual81/eurostat/tet00034_date_code_FF.rds
## Table tet00033 cached at /var/folders/5s/rkxr4m8j24569d_p6nj9ld200000gn/T//RtmpTual81/eurostat/tet00033_date_code_FF.rds
## Table tet00032 cached at /var/folders/5s/rkxr4m8j24569d_p6nj9ld200000gn/T//RtmpTual81/eurostat/tet00032_date_code_FF.rds
## Table tet00031 cached at /var/folders/5s/rkxr4m8j24569d_p6nj9ld200000gn/T//RtmpTual81/eurostat/tet00031_date_code_FF.rds
## Table tet00030 cached at /var/folders/5s/rkxr4m8j24569d_p6nj9ld200000gn/T//RtmpTual81/eurostat/tet00030_date_code_FF.rds
## Table tet00029 cached at /var/folders/5s/rkxr4m8j24569d_p6nj9ld200000gn/T//RtmpTual81/eurostat/tet00029_date_code_FF.rds

trades
## # A tibble: 720 × 5
##    sitc06                   partner                time        export import
##    &lt;chr&gt;                    &lt;fct&gt;                  &lt;date&gt;       &lt;dbl&gt;  &lt;dbl&gt;
##  1 Food, drinks and tobacco Argentina              2008-01-01    81.3  7334 
##  2 Food, drinks and tobacco Brazil                 2008-01-01   600.   9639.
##  3 Food, drinks and tobacco Canada                 2008-01-01  1950.   1458.
##  4 Food, drinks and tobacco Switzerland            2008-01-01  5000.   2727.
##  5 Food, drinks and tobacco China except Hong Kong 2008-01-01  1322.   3567.
##  6 Food, drinks and tobacco Japan                  2008-01-01  3964.    119.
##  7 Food, drinks and tobacco Norway                 2008-01-01  2416.   3012.
##  8 Food, drinks and tobacco Russia                 2008-01-01  7567.    855.
##  9 Food, drinks and tobacco Turkey                 2008-01-01  1175    3160.
## 10 Food, drinks and tobacco United States          2008-01-01 10021.   6030.
## # … with 710 more rows
```

---

## Загрузка данных NASA POWER


```r
daily_single_ag &lt;- get_power(
  community = "ag",
  lonlat = c(60.59, 56.84),
  pars = c("RH2M", "T2M"),
  dates = c("1995-04-01", "1995-04-30"),
  temporal_api = "daily"
)

daily_single_ag # посмотрим, что получилось
```

---

## Загрузка данных NASA POWER


```r
interannual_sse &lt;- get_power(
  community = "SSE",
  lonlat = c(60.59, 56.84),
  dates = 1995:2015,
  temporal_average = "INTERANNUAL",
  pars = c("CLRSKY_SFC_SW_DWN",
           "ALLSKY_SFC_SW_DWN")
)
interannual_sse # посмотрим, что получилось
```

---

## Загрузка данных Soil Data Access

Результирющий объект представляет собой список со множеством таблиц, которые характеризуют как почвенную серию в целом, так и отдельные ее разрезы:

```r
soils = c('wilkes',  'chewacla', 'congaree')
series = fetchOSD(soils, extended = TRUE)
str(series)
## List of 14
##  $ SPC             :Formal class 'SoilProfileCollection' [package "aqp"] with 9 slots
##   .. ..@ idcol       : chr "id"
##   .. ..@ hzidcol     : chr "hzID"
##   .. ..@ depthcols   : chr [1:2] "top" "bottom"
##   .. ..@ metadata    :List of 8
##   .. .. ..$ aqp_df_class    : chr "data.frame"
##   .. .. ..$ aqp_group_by    : chr ""
##   .. .. ..$ aqp_hzdesgn     : chr "hzname"
##   .. .. ..$ aqp_hztexcl     : chr "texture_class"
##   .. .. ..$ depth_units     : chr "cm"
##   .. .. ..$ stringsAsFactors: logi FALSE
##   .. .. ..$ original.order  : int [1:22] 1 2 3 4 5 6 7 8 9 10 ...
##   .. .. ..$ origin          : chr "OSD via Soilweb / fetchOSD"
##   .. ..@ horizons    :'data.frame':	22 obs. of  21 variables:
##   .. .. ..$ id                   : chr [1:22] "CHEWACLA" "CHEWACLA" "CHEWACLA" "CHEWACLA" ...
##   .. .. ..$ top                  : int [1:22] 0 10 36 66 97 119 152 0 20 46 ...
##   .. .. ..$ bottom               : int [1:22] 10 36 66 97 119 152 203 20 46 56 ...
##   .. .. ..$ hzname               : chr [1:22] "Ap" "Bw1" "Bw2" "Bw3" ...
##   .. .. ..$ soil_color           : chr [1:22] "#7E5A3BFF" "#7A5C37FF" "#7A5C37FF" "#7E5A3BFF" ...
##   .. .. ..$ hue                  : chr [1:22] "7.5YR" "10YR" "10YR" "7.5YR" ...
##   .. .. ..$ value                : int [1:22] 4 4 4 4 5 5 4 4 4 3 ...
##   .. .. ..$ chroma               : int [1:22] 4 4 4 4 8 1 4 4 3 3 ...
##   .. .. ..$ dry_hue              : chr [1:22] "7.5YR" "10YR" "10YR" "7.5YR" ...
##   .. .. ..$ dry_value            : int [1:22] 6 6 6 6 6 6 6 6 6 5 ...
##   .. .. ..$ dry_chroma           : int [1:22] 4 4 4 4 7 1 4 4 3 3 ...
##   .. .. ..$ texture_class        : Ord.factor w/ 21 levels "coarse sand"&lt;..: 13 18 17 13 17 17 13 13 13 NA ...
##   .. .. ..$ cf_class             : logi [1:22] NA NA NA NA NA NA ...
##   .. .. ..$ pH                   : logi [1:22] NA NA NA NA NA NA ...
##   .. .. ..$ pH_class             : Ord.factor w/ 12 levels "ultra acid"&lt;"extremely acid"&lt;..: 3 3 3 3 3 3 3 4 NA NA ...
##   .. .. ..$ distinctness         : chr [1:22] "clear" "gradual" "gradual" "gradual" ...
##   .. .. ..$ topography           : chr [1:22] "smooth" "wavy" "wavy" "wavy" ...
##   .. .. ..$ dry_color_estimated  : logi [1:22] TRUE TRUE TRUE TRUE TRUE TRUE ...
##   .. .. ..$ moist_color_estimated: logi [1:22] FALSE FALSE FALSE FALSE FALSE FALSE ...
##   .. .. ..$ narrative            : chr [1:22] "Ap--0 to 4 inches; brown (7.5YR 4/4) loam; weak medium granular structure; friable; common very fine, fine, and"| __truncated__ "Bw1--4 to 14 inches; dark yellowish brown (10YR 4/4) silty clay loam; weak medium subangular blocky structure; "| __truncated__ "Bw2--14 to 26 inches; dark yellowish brown (10YR 4/4) clay loam; weak medium subangular blocky structure; friab"| __truncated__ "Bw3--26 to 38 inches; brown (7.5YR 4/4) loam; weak medium subangular blocky structure; friable; common fine roo"| __truncated__ ...
##   .. .. ..$ hzID                 : chr [1:22] "1" "2" "3" "4" ...
##   .. ..@ site        :'data.frame':	3 obs. of  33 variables:
##   .. .. ..$ id                     : chr [1:3] "CHEWACLA" "CONGAREE" "WILKES"
##   .. .. ..$ soiltaxclasslastupdated: chr [1:3] "2010-02-11 00:00:00+00" "2002-07-18 00:00:00+00" "1997-06-06 00:00:00+00"
##   .. .. ..$ mlraoffice             : chr [1:3] "raleigh, nc" "raleigh, nc" "raleigh, nc"
##   .. .. ..$ series_status          : chr [1:3] "established" "established" "established"
##   .. .. ..$ family                 : chr [1:3] "fine-loamy, mixed, active, thermic fluvaquentic dystrudepts" "fine-loamy, mixed, active, nonacid, thermic oxyaquic udifluvents" "loamy, mixed, active, thermic, shallow typic hapludalfs"
##   .. .. ..$ soilorder              : chr [1:3] "inceptisols" "entisols" "alfisols"
##   .. .. ..$ suborder               : chr [1:3] "udepts" "fluvents" "udalfs"
##   .. .. ..$ greatgroup             : chr [1:3] "dystrudepts" "udifluvents" "hapludalfs"
##   .. .. ..$ subgroup               : chr [1:3] "fluvaquentic dystrudepts" "oxyaquic udifluvents" "typic hapludalfs"
##   .. .. ..$ tax_partsize           : chr [1:3] "fine-loamy" "fine-loamy" "loamy"
##   .. .. ..$ tax_partsizemod        : logi [1:3] NA NA NA
##   .. .. ..$ tax_ceactcl            : chr [1:3] "active" "active" "active"
##   .. .. ..$ tax_reaction           : chr [1:3] NA "nonacid" NA
##   .. .. ..$ tax_tempcl             : chr [1:3] "thermic" "thermic" "thermic"
##   .. .. ..$ originyear             : logi [1:3] NA NA NA
##   .. .. ..$ establishedyear        : int [1:3] 1937 1904 1916
##   .. .. ..$ descriptiondateinitial : chr [1:3] "2010-02-11 00:00:00+00" "2002-07-18 00:00:00+00" "2007-09-06 00:00:00+00"
##   .. .. ..$ descriptiondateupdated : chr [1:3] "2010-02-11 00:00:00+00" "2002-07-18 00:00:00+00" "2021-01-27 16:02:50+00"
##   .. .. ..$ benchmarksoilflag      : int [1:3] 1 0 0
##   .. .. ..$ statsgoflag            : int [1:3] 1 1 1
##   .. .. ..$ objwlupdated           : chr [1:3] "2012-08-01 14:06:37+00" "2012-08-01 14:06:37+00" "2021-01-27 16:02:50+00"
##   .. .. ..$ recwlupdated           : chr [1:3] "2012-08-01 14:06:37+00" "2012-08-01 14:06:37+00" "2021-01-27 16:02:50+00"
##   .. .. ..$ typelocstareaiidref    : int [1:3] 6691 6706 6691
##   .. .. ..$ typelocstareatypeiidref: int [1:3] 3 3 3
##   .. .. ..$ soilseriesiid          : int [1:3] 24628 1057 23800
##   .. .. ..$ soilseriesdbiidref     : int [1:3] 122 122 122
##   .. .. ..$ grpiidref              : int [1:3] 15801 15801 15801
##   .. .. ..$ tax_minclass           : chr [1:3] "mixed" "mixed" "mixed"
##   .. .. ..$ subgroup_mod           : chr [1:3] "fluvaquentic" "oxyaquic" "typic"
##   .. .. ..$ greatgroup_mod         : chr [1:3] "dystr" "udi" "hapl"
##   .. .. ..$ drainagecl             : chr [1:3] "somewhat poorly" "well to moderately well" "well"
##   .. .. ..$ ac                     : int [1:3] 1256820 216072 614614
##   .. .. ..$ n_polygons             : int [1:3] 39164 10384 34815
##   .. ..@ sp          :Formal class 'SpatialPoints' [package "sp"] with 3 slots
##   .. .. .. ..@ coords     : num [1, 1] 0
##   .. .. .. ..@ bbox       : logi [1, 1] NA
##   .. .. .. ..@ proj4string:Formal class 'CRS' [package "sp"] with 1 slot
##   .. .. .. .. .. ..@ projargs: chr NA
##   .. ..@ diagnostic  :'data.frame':	0 obs. of  0 variables
##   .. ..@ restrictions:'data.frame':	0 obs. of  0 variables
##  $ competing       :'data.frame':	1 obs. of  3 variables:
##   ..$ series   : chr "CHEWACLA"
##   ..$ competing: chr "OAKBORO"
##   ..$ family   : chr "fine-loamy, mixed, active, thermic fluvaquentic dystrudepts"
##  $ geog_assoc_soils:'data.frame':	22 obs. of  2 variables:
##   ..$ series: chr [1:22] "CONGAREE" "CONGAREE" "CONGAREE" "CONGAREE" ...
##   ..$ gas   : chr [1:22] "ALTAVISTA" "AUGUSTA" "BUNCOMBE" "CARTECAY" ...
##  $ geomcomp        :'data.frame':	3 obs. of  9 variables:
##   ..$ series         : chr [1:3] "CHEWACLA" "CONGAREE" "WILKES"
##   ..$ Interfluve     : num [1:3] 1 0 0.178
##   ..$ Crest          : num [1:3] 0 0 0.027
##   ..$ Head Slope     : int [1:3] 0 0 0
##   ..$ Nose Slope     : int [1:3] 0 0 0
##   ..$ Side Slope     : num [1:3] 0 0 0.795
##   ..$ Base Slope     : int [1:3] 0 1 0
##   ..$ n              : int [1:3] 3 1 185
##   ..$ shannon_entropy: num [1:3] 0 0 0.365
##  $ hillpos         :'data.frame':	3 obs. of  8 variables:
##   ..$ series         : chr [1:3] "CHEWACLA" "CONGAREE" "WILKES"
##   ..$ Toeslope       : num [1:3] 0.963 0.786 0
##   ..$ Footslope      : num [1:3] 0.0366 0.2143 0
##   ..$ Backslope      : num [1:3] 0 0 0.637
##   ..$ Shoulder       : num [1:3] 0 0 0.225
##   ..$ Summit         : num [1:3] 0 0 0.139
##   ..$ n              : int [1:3] 82 14 245
##   ..$ shannon_entropy: num [1:3] 0.0975 0.3228 0.5573
##  $ mtnpos          : logi FALSE
##  $ terrace         :'data.frame':	2 obs. of  5 variables:
##   ..$ series         : chr [1:2] "CHEWACLA" "CONGAREE"
##   ..$ Tread          : num [1:2] 0.977 1
##   ..$ Riser          : num [1:2] 0.023 0
##   ..$ n              : int [1:2] 87 36
##   ..$ shannon_entropy: num [1:2] 0.068 0
##  $ flats           :'data.frame':	2 obs. of  7 variables:
##   ..$ series         : chr [1:2] "CHEWACLA" "CONGAREE"
##   ..$ Dip            : num [1:2] 0.1455 0.0667
##   ..$ Talf           : num [1:2] 0.855 0.867
##   ..$ Flat           : int [1:2] 0 0
##   ..$ Rise           : num [1:2] 0 0.0667
##   ..$ n              : int [1:2] 55 15
##   ..$ shannon_entropy: num [1:2] 0.258 0.301
##  $ pmkind          :'data.frame':	6 obs. of  5 variables:
##   ..$ series: chr [1:6] "CHEWACLA" "CHEWACLA" "CONGAREE" "CONGAREE" ...
##   ..$ pmkind: chr [1:6] "Alluvium" "Residuum" "Alluvium" "Fluviomarine deposits" ...
##   ..$ n     : int [1:6] 206 1 72 13 1 262
##   ..$ total : int [1:6] 207 207 86 86 86 262
##   ..$ P     : num [1:6] 0.9952 0.0048 0.8372 0.1512 0.0116 ...
##  $ pmorigin        :'data.frame':	24 obs. of  5 variables:
##   ..$ series  : chr [1:24] "CHEWACLA" "CHEWACLA" "CHEWACLA" "CHEWACLA" ...
##   ..$ pmorigin: chr [1:24] "Igneous and metamorphic rock" "Sedimentary rock" "Mixed" "Granite and gneiss" ...
##   ..$ n       : int [1:24] 29 11 2 2 1 1 1 1 1 1 ...
##   ..$ total   : int [1:24] 51 51 51 51 51 51 51 51 51 51 ...
##   ..$ P       : num [1:24] 0.5686 0.2157 0.0392 0.0392 0.0196 ...
##  $ mlra            :'data.frame':	19 obs. of  4 variables:
##   ..$ series    : chr [1:19] "CHEWACLA" "CHEWACLA" "CHEWACLA" "CHEWACLA" ...
##   ..$ mlra      : chr [1:19] "129" "135A" "136" "133A" ...
##   ..$ area_ac   : int [1:19] 6166 3878 927251 128381 78428 60214 29004 13536 9495 2126 ...
##   ..$ membership: num [1:19] 0.005 0.003 0.738 0.102 0.062 0.048 0.023 0.011 0.008 0.01 ...
##  $ climate.annual  :'data.frame':	24 obs. of  12 variables:
##   ..$ series     : chr [1:24] "CHEWACLA" "CHEWACLA" "CHEWACLA" "CHEWACLA" ...
##   ..$ climate_var: chr [1:24] "Elevation (m)" "Effective Precipitation (mm)" "Frost-Free Days" "Mean Annual Air Temperature (degrees C)" ...
##   ..$ minimum    : num [1:24] 0 128.8 177 11.3 986 ...
##   ..$ q01        : num [1:24] 7 216.4 188 12.9 1069 ...
##   ..$ q05        : num [1:24] 34 247.4 196 13.5 1093 ...
##   ..$ q25        : num [1:24] 125 312.2 208 14.9 1136 ...
##   ..$ q50        : num [1:24] 192 349.8 218 15.7 1178 ...
##   ..$ q75        : num [1:24] 248 441.2 227 16.4 1276 ...
##   ..$ q95        : num [1:24] 348 568.8 235 17.3 1392 ...
##   ..$ q99        : num [1:24] 480 740.8 243 17.8 1575 ...
##   ..$ maximum    : num [1:24] 919 1382.8 300 19.7 2202 ...
##   ..$ n          : int [1:24] 32689 32689 32689 32689 32689 32689 32689 32689 8392 8392 ...
##  $ climate.monthly :'data.frame':	72 obs. of  14 variables:
##   ..$ series     : chr [1:72] "CHEWACLA" "CHEWACLA" "CHEWACLA" "CHEWACLA" ...
##   ..$ climate_var: chr [1:72] "ppt1" "ppt2" "ppt3" "ppt4" ...
##   ..$ minimum    : num [1:72] 61 64 81 63 60 78 83 74 68 53 ...
##   ..$ q01        : num [1:72] 74 71 92 71 69 83 92 85 81 72 ...
##   ..$ q05        : num [1:72] 82 73 98 75 72 89 100 89 86 76 ...
##   ..$ q25        : num [1:72] 93 83 105 83 81 96 108 96 91 82 ...
##   ..$ q50        : num [1:72] 105 107 120 88 92 101 116 102 98 86 ...
##   ..$ q75        : num [1:72] 115 121 128 95 101 106 123 110 105 91 ...
##   ..$ q95        : num [1:72] 131 135 137 111 111 117 133 129 118 100 ...
##   ..$ q99        : num [1:72] 149 144 147 122 125 133 143 142 137 109 ...
##   ..$ maximum    : num [1:72] 248 227 239 150 167 198 220 207 192 158 ...
##   ..$ n          : int [1:72] 32689 32689 32689 32689 32689 32689 32689 32689 32689 32689 ...
##   ..$ month      : Factor w/ 12 levels "1","2","3","4",..: 1 2 3 4 5 6 7 8 9 10 ...
##   ..$ variable   : Factor w/ 2 levels "Potential ET (mm)",..: 2 2 2 2 2 2 2 2 2 2 ...
##  $ soilweb.metadata:'data.frame':	18 obs. of  2 variables:
##   ..$ product    : chr [1:18] "block diagram archive" "cached sketches" "component pedons" "KSSL snapshot" ...
##   ..$ last_update: chr [1:18] "2019-12-17" "2021-10-07" "2020-12-08" "2020-03-18" ...
```

---

## Быстрый график ggplot

Суммарный экспорт по годам с использованием `qplot()`:

```r
trades_total = trades |&gt; 
  group_by(time) |&gt; 
  summarise(export = sum(export),
            import = sum(import))
  
qplot(time, export, 
      data = trades_total, 
      geom = c('point', 'line'))
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-7-1.png)&lt;!-- --&gt;

---

## Базовый шаблон ggplot

Базовый (минимально необходимый) шаблон построения графика через __ggplot__ выглядит следующим образом:

```r
ggplot(data = &lt;DATA&gt;) + 
  &lt;GEOM_FUNCTION&gt;(mapping = aes(&lt;MAPPINGS&gt;))
```
где:

- `DATA` --- источник данных (фрейм, тиббл)
- `GEOM_FUNCTION` --- функция, отвечающая за геометрический тип графика (точки, линии, гистограммы и т.д.)
- `MAPPINGS` --- перечень соответствий между переменными данных (содержащихся в `DATA`) и графическими переменными (координатами, размерами, цветами и т.д.)

---

## Геометрические типы

.pull-left[
Точки `geom_point()`:

```r
ggplot(data = trades_total) +
  geom_line(mapping = aes(x = time, y = export))
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-9-1.png)&lt;!-- --&gt;
]

.pull-right[
Линии `geom_line()`:

```r
ggplot(data = trades_total) +
  geom_line(mapping = aes(x = time, y = export))
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-10-1.png)&lt;!-- --&gt;
]


---

## Геометрические типы

.pull-left[
Ступенчатые кривые`geom_step()`:

```r
ggplot(data = trades_total) +
  geom_step(mapping = aes(x = time, y = export))
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-11-1.png)&lt;!-- --&gt;
]

.pull-right[
Совмещение геометрий:

```r
ggplot(data = trades_total) +
  geom_line(mapping = aes(x = time, y = export)) +
  geom_point(mapping = aes(x = time, y = export))
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-12-1.png)&lt;!-- --&gt;
]

---

## Геометрические типы

.pull-left[
Вынос общих данных:

```r
ggplot(data = trades_total, mapping = aes(x = time, y = export)) +
  geom_line() +
  geom_point()
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-13-1.png)&lt;!-- --&gt;
]

.pull-right[
Заливка `geom_area()`:

```r
ggplot(data = trades_total, mapping = aes(x = time, y = export)) +
  geom_area(alpha = 0.5) + # полигон с прозрачностью 0,5
  geom_line() +
  geom_point()
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-14-1.png)&lt;!-- --&gt;
]

---

## Геометрические типы


```r
df = trades |&gt; filter(sitc06 == 'Machinery and transport equipment', 
                      time == as.Date('2017-01-01'))
```

.pull-left[
Столбчатая диаграмма:

```r
ggplot(
  df, 
  mapping = aes(
    x = partner, 
    y = export
  )
) +
  geom_col()
```
]

.pull-right[
![](06_AdvGraphics_files/figure-html/barplot-out-1.png)&lt;!-- --&gt;
]

---

## Геометрические типы

.pull-right[
Перестановка осей через `coord_flip()`:

```r
ggplot(df, mapping = aes(x = partner, y = export)) +
  geom_col() +
  coord_flip()
```
]

.pull-right[
![](06_AdvGraphics_files/figure-html/flip-out-1.png)&lt;!-- --&gt;
]

---

## Графические переменные и группировки {#advgraphics_aes}

Графические переменные --- это параметры, определяющие внешний вид символов. К ним относятся цвет (тон, насыщенность и светлота), размер, форма, ориентировка, внутренняя структура символа. В ggplot значения графических переменных могут быть едиными для всех измерений, а могут зависеть от величины измерений. С точки зрения управления здесь все просто: если вы хотите, чтобы какой-то графический параметр зависел от значения показателя, он должен быть указан внутри конструкции `mapping = aes(...)`. Если необходимо, чтобы этот параметр был одинаковым для всех измерений, вы должны его указать внутри `&lt;GEOM_FUNCTION&gt;(...)`, то есть не передавать в `mapping`.

Для управления цветом, формой и размером (толщиной) графического примитива следует использовать параметры _color_, _shape_ и _size_ соответственно. Посмотрим, как они работают внутри и за пределами функции `aes()`:


```r
# один цвет для графика (параметр за пределами aes)
ggplot(trades_total) + 
    geom_line(mapping = aes(x = time, y = export), color = 'blue')
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-16-1.png)&lt;!-- --&gt;

```r

trade_russia = trades |&gt; dplyr::filter(partner == 'Russia')

ggplot(trade_russia) + # у каждой группы данных свой цвет (параметр внутри aes)
  geom_line(mapping = aes(x = time, y = export, color = sitc06))
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-16-2.png)&lt;!-- --&gt;

```r

ggplot(trade_russia, mapping = aes(x = time, y = export, color = sitc06)) + # а теперь и с точками
  geom_line() +
  geom_point()
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-16-3.png)&lt;!-- --&gt;

Аналогичным образом работает параметр формы значка:

```r
# один значок для графика
ggplot(trades_total) + 
    geom_point(mapping = aes(x = time, y = export), shape = 15)
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-17-1.png)&lt;!-- --&gt;

```r
    

ggplot(trade_russia) + # у каждой группы данных свой значок
    geom_point(mapping = aes(x = time, y = export, shape = sitc06))
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-17-2.png)&lt;!-- --&gt;

Для изменения размера значка или линии используйте параметр `size`:

```r
# изменение размера значка и линии
ggplot(trades_total, mapping = aes(x = time, y = export)) + 
    geom_point(size = 5) +
    geom_line(size = 2)
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-18-1.png)&lt;!-- --&gt;

Если вы используете зависимые от значений графические переменные и при этом хотите добавить на график еще одну геометрию (c постоянными параметрами), то вам необходимо сгруппировать объекты второй геометрии по той же переменной, по которой вы осуществляете разбиение в первой геометрии. Для этого используйте параметр `group`:

```r
ggplot(trade_russia, aes(x = time, y = export)) + 
    geom_point(aes(shape = sitc06)) +
    geom_line(aes(group = sitc06))
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-19-1.png)&lt;!-- --&gt;

Для изменения цвета столбчатых диаграмм следует использовать параметр `fill`, а цвет и толщина обводки определяются параметрами `color` и `size`:

```r
trades |&gt; 
  dplyr::filter(sitc06 == 'Machinery and transport equipment', time == as.Date('2017-01-01')) |&gt; 
  ggplot(mapping = aes(x = partner, y = export)) +
  geom_col(fill = 'plum4', color = 'black', size = 0.2) +
  coord_flip()
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-20-1.png)&lt;!-- --&gt;

Цвет на столбчатых диаграммах можно использовать для отображения дополнительных переменных, например типа экспортируемой продукции. По умолчанию столбики будут образовывать стек

```r
trades |&gt; 
  dplyr::filter(time == as.Date('2017-01-01')) |&gt; 
  ggplot(mapping = aes(x = partner, y = export, fill = sitc06)) +
  geom_col(color = 'black', size = 0.2) +
  coord_flip()
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-21-1.png)&lt;!-- --&gt;

Если вам важно не абсолютное количество, а процентное соотношение величин, вы можете применить вид группировки `position == 'fill`:

```r
trades |&gt; 
  dplyr::filter(time == as.Date('2017-01-01')) |&gt; 
  ggplot(mapping = aes(x = partner, y = export, fill = sitc06)) +
    geom_col(color = 'black', size = 0.2, position = 'fill') +
    coord_flip()
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-22-1.png)&lt;!-- --&gt;

Еще один вид группировки — это группировка по соседству. Чтобы использовать ее, применить метод `position == 'dodge`:

```r
trade_russia |&gt; 
  dplyr::filter(time &gt;= as.Date('2013-01-01')) |&gt; 
  ggplot(mapping = aes(x = time, y = export, fill = sitc06)) +
    geom_col(color = 'black', size = 0.2, position = 'dodge')
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-23-1.png)&lt;!-- --&gt;

## Системы координат {#advgraphics_coords}

__ggplot__ поддерживает множество полезных преобразований координат, таких как смена осей X и Y, переход к логарифмическим координатам и использование полярной системы вместо декартовой прямоугольной. 

Смена переменных происходит благодаря уже знакомой нам функции `coord_flip()`. Рассмотрим, например, как изменилась структура экспорта/импорта по годам:

```r
trades_type = trades |&gt; 
  group_by(sitc06, time) |&gt; 
  summarise(export = sum(export),
            import = sum(import))
## `summarise()` has grouped output by 'sitc06'. You can override using the `.groups` argument.

ggplot(trades_type) + 
    geom_point(mapping = aes(x = export, y = import, color = sitc06, size = time), alpha = 0.5)
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-24-1.png)&lt;!-- --&gt;

```r

ggplot(trades_type) + 
    geom_point(mapping = aes(x = export, y = import, color = sitc06, size = time), alpha = 0.5) +
    coord_flip()
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-24-2.png)&lt;!-- --&gt;

Поскольку объемы продукции различаются _на порядки_, для различимости малых объемов целесообразно перейти к логарифмической шкале. Для этого используем `scale_log_x()` и `scale_log_y()`:

```r
ggplot(trades_type, mapping = aes(x = export, y = import, color = sitc06, size = time)) + 
  geom_point(alpha = 0.5) +
  scale_x_log10() +
  scale_y_log10()
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-25-1.png)&lt;!-- --&gt;

Преобразование в полярную систему координат используется для того чтобы получить круговую секторную диаграмму Найтингейл (_coxcomb chart_):

```r
trades |&gt; 
  dplyr::filter(sitc06 == 'Machinery and transport equipment', time == as.Date('2017-01-01')) |&gt; 
  ggplot(mapping = aes(x = partner, y = export, fill = partner)) +
  geom_col() +
  coord_polar()
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-26-1.png)&lt;!-- --&gt;
 
Разумеется, здесь тоже можно использовать преобразование шкалы по оси _Y_ (которая теперь отвечает за радиус). Применим правило квадратного корня, добавив вызов функции `scale_y_sqrt()`:

```r
trades |&gt; 
  dplyr::filter(sitc06 == 'Machinery and transport equipment', time == as.Date('2017-01-01')) |&gt; 
  ggplot(mapping = aes(x = partner, y = export, fill = partner)) +
  geom_col() +
  coord_polar() +
  scale_y_sqrt()
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-27-1.png)&lt;!-- --&gt;

Чтобы построить классическую секторную диаграмму, необходимо, чтобы угол поворота соответствовал величине показателя (оси _Y_), а не названию категории (оси _X_). Для этого при вызове функции `coord_polar()` следует указать параметр `theta = 'y'`, а при вызове `geom_col()` оставить параметр `x` пустым:

```r
trades |&gt; 
  dplyr::filter(sitc06 == 'Machinery and transport equipment', time == as.Date('2017-01-01')) |&gt; 
  ggplot(mapping = aes(x = '', y = export, fill = partner), color = 'black', size = 0.2) +
  geom_col() +
  coord_polar(theta = 'y')
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-28-1.png)&lt;!-- --&gt;

## Названия осей и легенды {#advgraphics_titles}

ggplot предоставляет ряд функций для аннотирования осей и легенды. Для этого можно использовать одну из следующих функций:

- `labs(...)` модифицирует заголовок легенды для соответствующей графической переменной, либо заголовок/подзаголовок графика
- `xlab(label)` модифицирует подпись оси X
- `ylab(label)` модифицирует подпись оси Y
- `ggtitle(label, subtitle = NULL)` модифицирует заголовок и подзаголовок графика

Создадим подписи легенд, отвечающих за цвет и размер значка на графике соотношения импорта и экспорта разных видов продукции:

```r
ggplot(trades_type) + 
  geom_point(mapping = aes(x = export, y = import, color = sitc06, size = time), alpha = 0.5) +
  labs(color = "Вид продукции", size = 'Год')
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-29-1.png)&lt;!-- --&gt;

Добавим заголовок и подзаголовок графика:

```r
ggplot(trades_type) + 
  geom_point(mapping = aes(x = export, y = import, color = sitc06, size = time), alpha = 0.5) +
  labs(color = "Вид продукции", size = 'Год') +
  ggtitle('Соотношение импорта и экспорта в странах Евросоюза (млн долл. США)',
          subtitle = 'Данные по ключевым партнерам')
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-30-1.png)&lt;!-- --&gt;

Изменим подписи осей:

```r
ggplot(trades_type) + 
  geom_point(mapping = aes(x = export, y = import, color = sitc06, size = time), alpha = 0.5) +
  labs(color = "Вид продукции", size = 'Год') +
  ggtitle('Соотношение импорта и экспорта в странах Евросоюза (млн долл. США)',
          subtitle = 'Данные по ключевым партнерам') +
  xlab('Экспорт') +
  ylab('Импорт')
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-31-1.png)&lt;!-- --&gt;

## Разметка осей {#advgraphics_axes}

Первое, что вам скорее всего захочется убрать — это экспоненциальная запись чисел. На самом деле, эта запись не является параметром __ggplot__ или стандартной системы __graphics__. Количество значащих цифр, после которых число автоматически представляется в экспоненциальном виде, управляется параметром `scipen`. Мы можем задать его достаточно большим, чтобы запретить переводить любые разумные числа в экспоненциальный вид:

```r
options(scipen = 999)
ggplot(trades_type) + 
  geom_point(mapping = aes(x = export, y = import, color = sitc06, size = time), alpha = 0.5) +
  labs(color = "Вид продукции", size = 'Год') +
  ggtitle('Соотношение импорта и экспорта в странах Евросоюза (млн долл. США)',
          subtitle = 'Данные по ключевым партнерам') +
  xlab('Экспорт') +
  ylab('Импорт')
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-32-1.png)&lt;!-- --&gt;

Для управления разметкой осей необходимо использовать функции `scale_x_continuous()`, `scale_y_continuous()`, `scale_x_log10(...)`, `scale_y_log10(...)`, `scale_x_reverse(...)`, `scale_y_reverse(...)`, `scale_x_sqrt(...)`, `scale_y_sqrt(...)`, которые, с одной стороны, указывают тип оси, а с другой стороны — позволяют управлять параметрами сетки координат и подписями.

Для изменения координат линий сетки и подписей необходимо использовать, соответственно, параметры `breaks` и `labels`:

```r
ggplot(trades_type, mapping = aes(x = export, y = import, color = sitc06, size = time)) + 
  geom_point(alpha = 0.5) +
  scale_x_log10(breaks = seq(0, 500000, 100000)) +
  scale_y_log10(breaks = seq(0, 500000, 100000))
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-33-1.png)&lt;!-- --&gt;

В данном случае, как раз, будет достаточно полезным параметр `labels`, поскольку метки можно сделать более компактными, поделив их на 1000 (и не забыть потом указать, что объемы теперь указаны не в миллионах, а в миллиардах долларов):

```r
brks = seq(0, 500000, 100000)
ggplot(trades_type, mapping = aes(x = export, y = import, color = sitc06, size = time)) + 
  geom_point(alpha = 0.5) +
  scale_x_log10(breaks = brks, labels = brks / 1000) +
  scale_y_log10(breaks = brks, labels = brks / 1000)
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-34-1.png)&lt;!-- --&gt;

Для обычной шкалы используйте функции `scale_x_continuous()` и `scale_y_continuous()`:

```r
ggplot(trades_type, mapping = aes(x = export, y = import, color = sitc06, size = time)) + 
  geom_point(alpha = 0.5) +
  scale_x_continuous(breaks = brks, labels = brks / 1000) +
  scale_y_continuous(breaks = brks, labels = brks / 1000)
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-35-1.png)&lt;!-- --&gt;

Для того чтобы принудительно указать диапазоны осей и графических переменных, следует использовать функции `lims(...)`, `xlim(...)` и `ylim(...)`. Например, мы можем приблизиться в левый нижний угол графика, задав диапазон 0-200000 по обеим осям:

```r
ggplot(trades_type, mapping = aes(x = export, y = import, color = sitc06, size = time)) + 
  geom_point(alpha = 0.5) +
  xlim(0, 75000) +
  ylim(0, 75000)
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-36-1.png)&lt;!-- --&gt;

Функция `lims()` работает еще хитрее: она позволяет применять графические переменные только к ограниченному набору значений исходных данных. Например, таким путем я могу выделить на графике продукцию машиностроения:

```r
ggplot(trades_type, mapping = aes(x = export, y = import, color = sitc06, size = time)) + 
  geom_point(alpha = 0.5) +
  lims(color = 'Machinery and transport equipment')
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-37-1.png)&lt;!-- --&gt;

## Подписи и аннотации {#advgraphics_labels}

С точки зрения __ggplot__ текст на графике, отображающий входные данные, является одной из разновидностей геометрии. Размещается он с помощью функции `geom_text()`. Как и в случае с другими геометриями, параметры, зависящие от исходных данных, должны быть переданы внутри `mapping = aes(...)`:

```r
ggplot(data = trades_total, mapping = aes(x = time, y = export)) +
  geom_area(alpha = 0.5) + # полигон с прозрачностью 0,5
  geom_line() +
  geom_point() +
  geom_text(aes(label = floor(export / 1000))) # добавляем подписи
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-38-1.png)&lt;!-- --&gt;

Выравнивание подписи относительно якорной точки (снизу, сверху, справа, слева) по горизонтали и вертикали управляется параметрами `hjust` и `vjust`, а смещения по осям X (в координатах графика) — параметрами `nudge_x` и `nudge_y`:

```r
ggplot(data = trades_total, mapping = aes(x = time, y = export)) +
  geom_area(alpha = 0.5) + # полигон с прозрачностью 0,5
  geom_line() +
  geom_point() +
  geom_text(aes(label = floor(export / 1000)), 
            vjust = 0, nudge_y = 40000) # добавляем подписи
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-39-1.png)&lt;!-- --&gt;

Подписи с фоновой плашкой добавляются через функцию `geom_label()`, которая имеет аналогичный синтаксис:

```r
trades |&gt; 
  dplyr::filter(sitc06 == 'Machinery and transport equipment', time == as.Date('2017-01-01')) |&gt; 
  ggplot(mapping = aes(x = partner, y = export)) +
  geom_col(fill = 'plum4', color = 'black', size = 0.2) +
  coord_flip() +
  geom_label(aes(y = export / 2, label = floor(export / 1000))) # добавляем подписи
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-40-1.png)&lt;!-- --&gt;

__Аннотации__ представляют собой объекты, размещаемые на графике вручную, и используемые, как правило, для выделения объектов и областей. Для размещения аннотаций используется функция `annotate()`:

```r
ggplot(data = trades_total, mapping = aes(x = time, y = export)) +
  geom_area(alpha = 0.5) + # полигон с прозрачностью 0,5
  geom_line() +
  geom_point() +
  geom_text(aes(label = floor(export / 1000)), 
            vjust = 0, nudge_y = 40000) +
  annotate("text", x = as.Date('2009-01-01'), y = 550000, label = "Это провал", color = 'red')
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-41-1.png)&lt;!-- --&gt;

Аннотировать можно не только подписями, но и регионами. Например, мы можем выделить область, которая соответствует импорту/экспорту продукции химической промышленности:

```r
ggplot(trades_type, mapping = aes(x = export, y = import, color = sitc06, size = time)) + 
  annotate("rect", xmin = 100000, xmax = 250000, ymin = 75000, ymax = 175000,  alpha = .2, color = 'black', size = 0.1) +
  geom_point(alpha = 0.5) +
  annotate("text", x = 175000, y = 190000, label = "Chemicals", color = 'coral')
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-42-1.png)&lt;!-- --&gt;


## Фасеты {#advgraphics_facets}

Фасеты представляют собой множество графиков, каждый из которых отображает свою переменную или набор значений. Для разбиения на фасеты используется функция facet_wrap(), которой необходимо передать переменную разбиения с _тильдой_. Например, рассмотрим изменение структуры импорта по годам:

```r
brks = c(0, 50, 100, 150, 200)
trades |&gt; 
  dplyr::filter(sitc06 == 'Machinery and transport equipment') |&gt; 
  ggplot(mapping = aes(x = partner, y = import)) +
  geom_col() +
  scale_y_continuous(breaks = brks * 1e3, labels = brks) +
  ggtitle('Импорт продукции машиностроения (мдрд долл. США)',
        subtitle = 'Данные по ключевым партнерам') +
  coord_flip() +
  facet_wrap(~time)
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-43-1.png)&lt;!-- --&gt;

## Темы {#advgraphics_themes}

Система __ggplot__ интересна также тем, что для нее существует множество предопределенных "тем" или скинов для оформления графиков. [Часть из них](https://ggplot2.tidyverse.org/reference/ggtheme.html) входит в состав самой библиотеки. Дополнительные темы можно установить через пакет [__ggthemes__](https://cran.r-project.org/web/packages/ggthemes/index.html). Чтобы изменить тему оформления ggplot, достаточно прибавить в конце построения графика соответствующую функцию. Например, классическая черно-белая тема получается прибавлением функции `theme_bw()`:

```r
ggplot(data = trades_total, mapping = aes(x = time, y = export)) +
  geom_area(alpha = 0.5) + # полигон с прозрачностью 0,5
  geom_line() +
  geom_point() +
  geom_text(aes(label = floor(export / 1000)), 
            vjust = 0, nudge_y = 40000) +
  theme_bw()
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-44-1.png)&lt;!-- --&gt;

```r

ggplot(trades_type) + 
  geom_point(mapping = aes(x = export, y = import, color = sitc06, size = time), alpha = 0.5) +
  labs(color = "Вид продукции", size = 'Год') +
  ggtitle('Соотношение импорта и экспорта в странах Евросоюза (млн долл. США)',
          subtitle = 'Данные по ключевым партнерам') +
  xlab('Экспорт') +
  ylab('Импорт') +
  theme_bw()
```

![](06_AdvGraphics_files/figure-html/unnamed-chunk-44-2.png)&lt;!-- --&gt;

## Контрольные вопросы и упражнения {#questions_tasks_advgraphics}

### Вопросы {#questions_advgraphics}

1. Назовите три основных компоненты шаблона построения графика в __ggplot2__.
1. Как называются геометрии __ggplot2__, отвечающие за построение точек, линий и ступенчатых линий?
1. Как называется геометрия __ggplot2__, отвечающая за построение столбчатой диаграммы?
1. Как сделать так, чтобы графический параметр __ggplot2__ был постоянным для всех измерений?
1. Как сделать так, чтобы графический параметр __ggplot2__ зависел от значения переменной?
1. Перечислите названия параметров, отвечающих за цвет, размер, заливку и тип значка графического примитива.
1. Если вы используете зависимые от значений графические переменные и при этом хотите добавить на график еще одну геометрию с постоянными параметрами, то как это можно реализовать?
1. Перечислите названия режимов группировки столбчатых диаграмм и пути их реализации.
1. Какая функция ggplot2 позволяет поменять местами оси координат?
1. Перечислите типы шкал для осей координат, которые доступны в __ggplot2__.
1. Назовите функцию, позволяющую перейти к полярной системе координат при построении графика в __ggplot2__.
1. В чем отличие построения розы-диаграммы (_coxcomb chart_) и секторной диаграммы (_pie chart_) средствами __ggplot2__?
1. Что делает функция `labs()`?
1. Какие функции позволяют определить названия осей и заголовок графика?
1. Что делает функция `lims()`?
1. Как ограничить область построения графика заданным диапазоном значений координат?
1. Как ограничить применение графических переменных только к определенным значениям измерений?
1. Назовите геометрии, которые позволяют размещать подписи и подписи с плашками (фоном) на графиках __ggplot2__.
1. Чем отличаются аннотации от геометрии подписей в __ggplot__? Какие виды аннотаций можно создавать?
1. Каким образом можно построить фасетный график, на котором каждое изображение соответствует значению переменной? Каков синтаксис вызова соответствующей функции?
1. Как поменять стиль отображения (тему) графика __ggplot2__?
1. Как получить программный доступ к таблицам Евростата, не прибегая к закачке файлов? Какой пакет можно использовать для этого?
1. Что является уникальным идентификатором таблицы в данных Евростата и как его узнать?
1. Как преобразовать коды Евростата в загруженных таблицах в человеко-читаемые обозначения?

### Упражнения {#tasks_advgraphics}

1. Постройте линейный график хода температуры , а также столбчатую диаграмму хода суммарной солнечной радиации в Екатеринбурге на примере данных NASA POWER, загруженных в разделе [6.3](#advgraphics_nasapower).&lt;!-- \@ref(advgraphics_nasapower). --&gt;

    &gt; __Подсказка__: Для построения столбчатой диаграммы вам потребуется использовать функцию `geom_col()`, поскольку высота столбика отражает не встречаемость значения, а величину переменной. Также вам потребуется преобразовать таблицу среднемесячных величин к длинной форме, где название месяца будет отдельной переменной (тип — упорядоченный фактор).

2. Загрузите [таблицу данных по импорту/экспорту продуктов питания, напитков и табака](https://ec.europa.eu/eurostat/databrowser/view/tet00034/default/table?lang=en) с портала Евростата (с использованием пакета __eurostat__). Постройте линейный график изменения _суммарных_ величин импорта и экспорта по данному показателю (у вас должно получиться 2 графика на одном изображении). Используйте _цвет_ для разделения графиков. Добавьте текстовые подписи величин импорта и экспорта. Постройте также две круговых диаграммы, показывающих соотношение ведущих импортеров и экспортеров за последний имеющийся год. Сделайте сначала это отдельными графиками, а затем одним фасетным графиком (для этого потребуется привести таблицу к длинной форме).

----
_Самсонов Т.Е._ **Визуализация и анализ географических данных на языке R.** М.: Географический факультет МГУ, 2021. DOI: [10.5281/zenodo.901911](https://doi.org/10.5281/zenodo.901911)
----
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightLines": true,
"countIncrementalSlides": false,
"ratio": "16:9"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
